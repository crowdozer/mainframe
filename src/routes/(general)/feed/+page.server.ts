import type { PageServerLoad } from './$types';
import { generateFeed } from '$server/feed/generate';
import { STALE_TIMER } from '$server/feed/const';
import type { Feed } from '$web/components/Feed/types';

/**
 * Setup ISR for the page
 * @see https://kit.svelte.dev/docs/adapter-vercel#incremental-static-regeneration
 */
export const config = {
	isr: {
		// Expiration time (in seconds) before the cached asset will be re-generated by invoking the Serverless Function.
		// Setting the value to `false` means it will never expire.
		//
		// We'll go half of the cache stale timer, just to be safe
		expiration: STALE_TIMER / 2,
	},
};

/**
 * Loads necessary page data
 */
export const load = async function ({ fetch }) {
	const feed = await generateFeed(fetch);

	return {
		...feed,
		ISR: new Date(),
	} as Feed;
} satisfies PageServerLoad;
