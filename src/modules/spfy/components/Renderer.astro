---
/**
	do not include this one on the page directly
	this one is exclusively for rendering the partial
 */
import HotLoader from './HotLoader.astro'
import { getProgressRenderData } from '../utils/shared'

interface Props {
	// duration of the song (in ms)
	duration: number
	// progress of the player (in ms)
	progress: number
	// name of the album
	albumText: string
	// name of the song
	songText: string
	// name of the artist
	artistText: string
	// link to the song
	url: string
	// image url
	image: string
}

const { duration, progress, albumText, songText, artistText, url, image } =
	Astro.props

const { progressPercent, progressText, durationText } = getProgressRenderData(
	progress,
	duration,
)

// intelligently throttle this to target the end of a song
// determine # of remaining seconds, add 1, refresh then.
// OR in 30 seconds, whichever is sooner .
const endOfSongIn = Math.round((duration - progress) / 1000) + 1
const interval = endOfSongIn < 30 ? `${endOfSongIn}s` : '30s'
---

<HotLoader {interval}>
	<div class="space-y-2">
		<!-- the pretty stuff -->
		<div class="flex flex-row gap-2">
			<div class="shrink-0">
				<img
					src={image}
					alt={`${albumText} cover art`}
					loading="lazy"
					class="h-[48px] w-[48px] border border-neutral-ui"
					title={albumText}
				/>
			</div>
			<div class="grow">
				<a
					href={url}
					class="line-clamp-2"
					title={songText}
					target="_blank"
					rel="noopener noreferrer"
				>
					<span class="block font-bold">{songText}</span>
				</a>
				<p class="line-clamp-1 text-sm" title={artistText}>
					{artistText}
				</p>
			</div>
		</div>

		<!-- progress bar -->
		<div class="relative overflow-hidden border border-neutral-ui">
			<div class="relative z-[2] flex flex-row px-1 py-0.5">
				<span class="text-xs" id="spfy-player-progress-text">
					{progressText}
				</span>
				<div class="grow"></div>
				<span class="text-xs">
					{durationText}
				</span>
			</div>

			<div
				class="glimmer glimmer-bright absolute bottom-0 left-0 top-0 z-[1]"
				style={{ width: `${progressPercent}%` }}
				id="spfy-player-progress-bar"
			>
			</div>
		</div>
	</div>
</HotLoader>
