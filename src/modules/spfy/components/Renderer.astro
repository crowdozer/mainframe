---
/**
	do not include this one on the page directly
	this one is exclusively for rendering the partial
 */
import HotLoader from './HotLoader.astro'
import { getProgressRenderData } from '../utils/shared'
import { CLIENT_HTMX_IDLE_DURATION } from '../config'

interface Props {
	// duration of the song (in ms)
	duration: number
	// progress of the player (in ms)
	progress: number
	// name of the album
	albumText: string
	// name of the song
	songText: string
	// name of the artist
	artistText: string
	// link to the song
	url: string
	// image url
	image: string
}

const { duration, progress, albumText, songText, artistText, url, image } =
	Astro.props

/**
 * transform milliseconds to hh:mm:ss strings
 */
const { progressPercent, progressText, durationText } = getProgressRenderData(
	progress,
	duration,
)

/**
 * if we're near the end of the song, delay the htmx
 * reload to target right after the end of the song
 *
 * otherwise, just reload using the standard idle duration
 */
function getSmartInterval() {
	let endOfSongIn = Math.round((duration - progress) / 1000)

	if (endOfSongIn >= CLIENT_HTMX_IDLE_DURATION) {
		return CLIENT_HTMX_IDLE_DURATION
	}

	if (endOfSongIn < 2) {
		return 2
	}

	return endOfSongIn
}
const interval = getSmartInterval()
---

<HotLoader interval={`${interval}s`}>
	<div class="space-y-2">
		<!-- the pretty stuff -->
		<div class="flex flex-row gap-2">
			<div class="shrink-0">
				<img
					src={image}
					alt={`${albumText} cover art`}
					loading="lazy"
					class="h-[48px] w-[48px] border border-neutral-ui"
					title={albumText}
				/>
			</div>
			<div class="grow">
				<a
					href={url}
					class="line-clamp-2"
					title={songText}
					target="_blank"
					rel="noopener noreferrer"
				>
					<span class="block font-bold">{songText}</span>
				</a>
				<p class="line-clamp-1 text-sm" title={artistText}>
					{artistText}
				</p>
			</div>
		</div>

		<!-- progress bar -->
		<div class="relative overflow-hidden border border-neutral-ui">
			<div class="relative z-[2] flex flex-row px-1 py-0.5">
				<span class="text-xs" id="spfy-player-progress-text">
					{progressText}
				</span>
				<div class="grow"></div>
				<span class="text-xs">
					{durationText}
				</span>
			</div>

			<div
				class="glimmer glimmer-bright absolute bottom-0 left-0 top-0 z-[1]"
				style={{ width: `${progressPercent}%` }}
				id="spfy-player-progress-bar"
			>
			</div>
		</div>
	</div>
</HotLoader>
